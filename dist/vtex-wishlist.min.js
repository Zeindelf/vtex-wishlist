/*!!
 * VtexWishlist.js v0.1.0
 * https://github.com/zeindelf/vtex-wishlist
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-03-12T06:34:24.578Z
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.VTEX=e.VTEX||{},e.VTEX.VtexWishlist=t())}(this,function(){"use strict";var e="1.2.0",a={DELAY_TIME:150,STORAGE_NAME:"__vtexWishlist.attributes__",SESSION_NAME:"__vtexWishlist.session__",RETRIEVED_DATA:["wishlistProducts"],MESSAGES:{vtexUtils:"VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils",vtexUtilsVersion:e,vtexUtilsVersionMessage:"VtexUtils version must be higher than 1.2.0. Download last version on https://www.npmjs.com/package/vtex-utils",vtexMasterdata:"VtexMasterdata.js is required. Download it from https://www.npmjs.com/package/vtex-masterdata",storeName:"The option 'storeName' is required and must be a string.",shelfId:"The option 'shelfId' is required and must be a string.",notFound:"The option 'notFound' must be a function."}},t={activeClass:"is--active",inactiveClass:"is--inactive",loaderClass:"has--wishlist-loader",linkTitle:{add:"Adicionar a wishlist",remove:"Remover da wishlist"},order:"OrderByPriceASC",notFound:null,zeroPadding:!1},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function i(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,s){return t&&i(e.prototype,t),s&&i(e,s),e}}(),i=new(function(){function e(){n(this,e)}return s(e,[{key:"_setInstance",value:function(e){this._self=e,this._vtexHelpers=e.vtexHelpers,this._globalHelpers=e.globalHelpers,this._vtexMasterdata=e.vtexMasterdata,this._vtexCatalog=e.vtexCatalog,this._storage=e.storage,this._session=e.storage.session}},{key:"_initStorage",value:function(){this._globalHelpers.isNull(this._storage.get(a.STORAGE_NAME))&&this._storage.set(a.STORAGE_NAME,{userEmail:null,userId:null,productsId:[]}),this._globalHelpers.isNull(this._session.get(a.SESSION_NAME))&&this._session.set(a.SESSION_NAME,{userDefined:!1})}},{key:"_setWishlistProduct",value:function(){var r=this;$(document).on("click","[data-wishlist-add]",this._globalHelpers.debounce(function(e){e.preventDefault();var t=$(e.currentTarget),s=t.data("wishlistProductId"),i=r._storage.get(a.STORAGE_NAME);return!r._session.get(a.SESSION_NAME).userDefined&&0<r._globalHelpers.length(i.productsId)?(r._setWishlistUser(),r._vtexHelpers.openPopupLogin(!0),!1):r._checkUserEmail()?(t.addClass(r._self.options.loaderClass),$(":button").prop("disabled",!0),r._removeWishlistProduct(s,t),void r._addWishlistProduct(s,t)):(r._vtexHelpers.openPopupLogin(!0),!1)},70))}},{key:"_addWishlistProduct",value:function(t,s){var i=this,e=this._storage.get(a.STORAGE_NAME);e.productsId.some(function(e){return e===t})||(this._requestStartEvent(),this._requestAddStartEvent(),e.productsId.push(t),this._storage.set(a.STORAGE_NAME,e),this._vtexMasterdata.updateUser(e.userEmail,{wishlistProducts:JSON.stringify(e.productsId)}).done(function(e){s.addClass(i._self.options.activeClass),s.attr("title",i._self.options.linkTitle.remove),s.removeClass(i._self.options.loaderClass),$(":button").prop("disabled",!1),i._requestEndEvent(t),i._requestAddEndEvent(t),i._storageObserve()}).fail(function(e){return window.console.log(e)}))}},{key:"_removeWishlistProduct",value:function(s,t){var i=this,r=this._storage.get(a.STORAGE_NAME),e=r.productsId.some(function(e){return e===s}),n=r.productsId.filter(function(e){return e!==s});if(t.hasClass(this._self.options.activeClass))return this._requestStartEvent(),this._requestRemoveStartEvent(),e&&this._vtexMasterdata.updateUser(r.userEmail,{wishlistProducts:JSON.stringify(n)}).done(function(e){t.removeClass(i._self.options.activeClass),t.attr("title",i._self.options.linkTitle.add),r.productsId=n,i._storage.set(a.STORAGE_NAME,r),t.removeClass(i._self.options.loaderClass),$(":button").prop("disabled",!1),$(document).find("[data-wishlist-add]").map(function(e,t){s===$(t).data("wishlistProductId")&&$(t).removeClass(i._self.options.activeClass)}),i._requestEndEvent(s),i._requestRemoveEndEvent(s),i._storageObserve()}).fail(function(e){return window.console.log(e)}),!1}},{key:"_clearWishlist",value:function(){var i=this;$(document).on("click","[data-wishlist-clear]",function(e){e.preventDefault();var t=$(document).find("[data-wishlist-add]"),s=i._storage.get(a.STORAGE_NAME);if(s.productsId.length<1)return!1;i._beforeClearItemsEvent(),s.productsId=[],i._storage.set(a.STORAGE_NAME,s),i._vtexMasterdata.updateUser(s.userEmail,{wishlistProducts:"[]"}).done(function(e){t.map(function(e,t){return $(t).removeClass(i._self.options.activeClass)}),i._storageObserve(),i._renderProducts()}).fail(function(e){return window.console.log(e)}).always(function(){return i._afterClearItemsEvent()})})}},{key:"_storageObserve",value:function(){var i=this,e=this._storage.get(a.STORAGE_NAME);if(this._setUserData(),this._globalHelpers.isNull(e))$("[data-wishlist-amount]").html(this._setPadding(0));else{var t=$(document).find("[data-wishlist-add]");$("[data-wishlist-amount]").html(this._setPadding(e.productsId.length)),e.productsId.map(function(s){t.map(function(e,t){s===$(t).data("wishlistProductId")&&$(t).addClass(i._self.options.activeClass)})})}}},{key:"_checkUserEmail",value:function(){return null!==this._storage.get(a.STORAGE_NAME).userEmail}},{key:"_setUserData",value:function(){var t=this,s=this._storage.get(a.STORAGE_NAME),i=this._session.get(a.SESSION_NAME);if(!i.userDefined&&0<this._globalHelpers.length(s.productsId))return!1;this._vtexHelpers.checkLogin().done(function(e){s.userEmail=e.Email,s.userId=e.UserId,t._storage.set(a.STORAGE_NAME,s),i.userDefined||t._setWishlistUser()})}},{key:"_setWishlistUser",value:function(){var i=this;this._checkWishlistUser().done(function(e){if(e.hasUser){var t=i._storage.get(a.STORAGE_NAME),s=i._session.get(a.SESSION_NAME);t.productsId=JSON.parse(e.userData.wishlistProducts||"[]"),s.userDefined=!0,i._storage.set(a.STORAGE_NAME,t),i._session.set(a.SESSION_NAME,s),setTimeout(function(){return i._storageObserve()},a.DELAY_TIME)}}).fail(function(e){return window.console.log(e)})}},{key:"_checkWishlistUser",value:function(){var s=this,e=this._storage.get(a.STORAGE_NAME),i=this._session.get(a.SESSION_NAME),r={hasUser:!1,userData:null};return $.Deferred(function(t){return!i.userDefined&&s._vtexMasterdata.getUser(e.userEmail,a.RETRIEVED_DATA).done(function(e){0<s._globalHelpers.length(e.result.dataResponse)&&(r.hasUser=!0,r.userData=e.result.dataResponse),t.resolve(r)}).fail(function(e){return t.reject(e)})}).promise()}},{key:"_renderProducts",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,s=$("[data-wishlist-items"),i=$("[data-wishlist-order]"),r=$('<ul class="vw-wishlist__items"></ul>'),n=this._storage.get(a.STORAGE_NAME),o={fq:n.productsId,shelfId:this._self.options.shelfId,order:e||this._self.options.order};if(this._beforeShowItemsEvent(),n.productsId.length<1)return i.addClass(this._self.options.inactiveClass),s.empty().append(this._self.options.notFound),this._afterShowItemsEvent(),!1;this._vtexCatalog.searchPage(o,!0).then(function(e){i.removeClass(t._self.options.inactiveClass),s.empty().append(r.append(e)),t._storageObserve()}).fail(function(e){return window.console.log(e)}).always(function(){return t._afterShowItemsEvent()})}},{key:"_changeOrder",value:function(){var s=this;$("[data-wishlist-order]").find("input").on("change",function(e){e.preventDefault();var t=$(e.currentTarget).val();s._renderProducts(t)})}},{key:"_setPadding",value:function(e){return this._self.options.zeroPadding?this._self.globalHelpers.pad(e):e}},{key:"_requestStartEvent",value:function(){var e=$.Event("requestStart.vtexWishlist");$(document).trigger(e)}},{key:"_requestAddStartEvent",value:function(){var e=$.Event("requestAddStart.vtexWishlist");$(document).trigger(e)}},{key:"_requestRemoveStartEvent",value:function(){var e=$.Event("requestRemoveStart.vtexWishlist");$(document).trigger(e)}},{key:"_requestEndEvent",value:function(e){var t=$.Event("requestEnd.vtexWishlist");$(document).trigger(t,[e])}},{key:"_requestAddEndEvent",value:function(e){var t=$.Event("requestAddEnd.vtexWishlist");$(document).trigger(t,[e])}},{key:"_requestRemoveEndEvent",value:function(e){var t=$.Event("requestRemoveEnd.vtexWishlist");$(document).trigger(t,[e])}},{key:"_beforeShowItemsEvent",value:function(){var e=$.Event("beforeShowItems.vtexWishlist");$(document).trigger(e)}},{key:"_afterShowItemsEvent",value:function(){var e=$.Event("afterShowItems.vtexWishlist");$(document).trigger(e)}},{key:"_beforeClearItemsEvent",value:function(){var e=$.Event("beforeClearItems.vtexWishlist");$(document).trigger(e)}},{key:"_afterClearItemsEvent",value:function(){var e=$.Event("afterClearItems.vtexWishlist");$(document).trigger(e)}}]),e}()),o={setOptions:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this.options=this.globalHelpers.extend({},t,this.globalHelpers.isPlainObject(e)&&e),!this.options.storeName||!this.globalHelpers.isString(this.options.storeName))throw new Error(a.MESSAGES.storeName);if(!this.options.shelfId||!this.globalHelpers.isString(this.options.shelfId))throw new Error(a.MESSAGES.shelfId);if(null===this.options.notFound)this.options.notFound=function(){return'<div class="wishlist__not-found">Nenhum produto em sua lista</div>'};else{if(!this.globalHelpers.isFunction(this.options.notFound))throw new Error(a.MESSAGES.notFound);this.options.notFound.call(this)}this.vtexMasterdata.setStore(this.options.storeName),i._setInstance(this),this._initWishlist()},_initWishlist:function(){var t=this;i._initStorage(),i._storageObserve(),i._setWishlistProduct(),i._changeOrder(),i._clearWishlist(),$(window).on("authenticatedUser.vtexid",function(e){return setTimeout(function(){return t.update()},a.DELAY_TIME)}),$(window).on("closed.vtexid",function(e){return setTimeout(function(){return t.update()},a.DELAY_TIME)}),$(document).on("requestAddEnd.vtexWishlist",function(e,t){return i._renderProducts()}),$(document).on("requestRemoveEnd.vtexWishlist",function(e,t){return i._renderProducts()})},update:function(){i._storageObserve(),i._renderProducts()},renderProducts:function(){i._renderProducts()}};return function e(t,s,i){var r=3<arguments.length&&void 0!==arguments[3]&&arguments[3];if(n(this,e),this.version="0.1.0",this.name="@VtexWishlist",void 0===t)throw new TypeError(a.MESSAGES.vtexUtils);if("@VtexUtils"!==t.name)throw new TypeError(a.MESSAGES.vtexUtils);if(t.version<a.MESSAGES.vtexUtilsVersion)throw new Error(a.MESSAGES.vtexUtilsVersionMessage);if(this.globalHelpers=t.globalHelpers,this.vtexHelpers=t.vtexHelpers,void 0===s)throw new Error(a.MESSAGES.vtexMasterdata);this.vtexMasterdata=s,this.vtexCatalog=new i(t,r),this.storage=t.storage,this.globalHelpers.extend(e.prototype,o)}});