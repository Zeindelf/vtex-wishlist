/*!!
 * VtexWishlist.js v0.3.0
 * https://github.com/zeindelf/vtex-wishlist
 *
 * Copyright (c) 2017-2018 Zeindelf
 * Released under the MIT license
 *
 * Date: 2018-03-20T03:07:13.581Z
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t.VTEX=t.VTEX||{},t.VTEX.VtexWishlist=e())}(this,function(){"use strict";var t="1.2.0",a={DELAY_TIME:150,STORAGE_NAME:"_vw_attributes",SESSION_NAME:"_vw_session",RETRIEVED_DATA:["wishlistProducts"],MESSAGES:{vtexUtils:"VtexUtils.js is required and must be an instance. Download it from https://www.npmjs.com/package/vtex-utils",vtexUtilsVersion:t,vtexUtilsVersionMessage:"VtexUtils version must be higher than 1.2.0. Download last version on https://www.npmjs.com/package/vtex-utils",vtexMasterdata:"VtexMasterdata.js is required. Download it from https://www.npmjs.com/package/vtex-masterdata",storeName:"The option 'storeName' is required and must be a string.",shelfId:"The option 'shelfId' is required and must be a string.",notFound:"The option 'notFound' must be a function.",wishlistItems:"You'll need declare an container with data attribute '<div data-wishlist-items=\"\"></div>' to append your list."},EVENTS:{REQUEST_START:"requestStart.vtexWishlist",REQUEST_ADD_START:"requestAddStart.vtexWishlist",REQUEST_REMOVE_START:"requestRemoveStart.vtexWishlist",REQUEST_END:"requestEnd.vtexWishlist",REQUEST_ADD_END:"requestAddEnd.vtexWishlist",REQUEST_REMOVE_END:"requestRemoveEnd.vtexWishlist",BEFORE_SHOW_ITEMS:"beforeShowItems.vtexWishlist",AFTER_SHOW_ITEMS:"afterShowItems.vtexWishlist",BEFORE_ORDER_BY_ITEMS:"beforeOrderByItems.vtexWishlist",AFTER_ORDER_BY_ITEMS:"afterOrderByItems.vtexWishlist",BEFORE_CLEAR_ITEMS:"beforeClearItems.vtexWishlist",AFTER_CLEAR_ITEMS:"afterClearItems.vtexWishlist"},BODY:$("body")},e={orderBy:"OrderByPriceASC",notFound:null,zeroPadding:!1,reloadPage:!0,perPage:12,linkTitle:{add:"Adicionar a wishlist",remove:"Remover da wishlist"},activeClass:"is--active",emptyClass:"is--wishlist-empty",loaderClass:"has--wishlist-loader",itemsClass:"vw-items",itemClass:"vw-item",orderByBodyClass:"has--wishlist-order-by",loadMoreBodyClass:"has--wishlist-load-more",loadMoreWrapperClass:"vw-load-more-wrapper",loadMoreBtnClass:"vw-load-more-btn",loadMoreText:"Carregar mais"},s={_renderProducts:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,s=$("[data-wishlist-items]"),i=this._storage.get(a.STORAGE_NAME),o={quantity:this._self.options.perPage*t,fq:i.productsId,shelfId:this._self.options.shelfId,order:this._self.options.orderBy};return!(s.length<1)&&($(document).trigger(a.EVENTS.BEFORE_SHOW_ITEMS),i.productsId.length<1?(this._setEmptyAttr(s),!1):void this._vtexCatalog.searchPage(o,!0).then(function(t){if(t.length<1)return e._setEmptyAttr(s),!1;t.removeClass("first last").addClass(e._self.options.itemClass),e._removeEmptyClass(),s.empty().append(t),e._storageObserve()}).fail(function(t){return window.console.log(t)}).always(function(){e._removeLoadMoreClass(),$(document).trigger(a.EVENTS.AFTER_SHOW_ITEMS)}))},_changeOrder:function(){var i=this;$("[data-wishlist-order-by]").find("input").on("change",function(t){t.preventDefault();var e=$(t.currentTarget),s=e.val();$(document).trigger(a.EVENTS.BEFORE_ORDER_BY_ITEMS),i._addOrderByClass(),i._resetLoadMoreBtn(),i._setUrlHash(),e.parent("label").addClass(i._self.options.activeClass),e.parent("label").siblings().removeClass(i._self.options.activeClass),i._self.options.orderBy=s,i._renderProducts(),$(document).one("afterShowItems.vtexWishlist",function(t){$(document).trigger(a.EVENTS.AFTER_ORDER_BY_ITEMS),i._removeOrderByClass()})})},_setEmptyAttr:function(t){this._addEmptyClass(),t.empty().append(this._self.options.notFound),$(document).trigger(a.EVENTS.AFTER_SHOW_ITEMS)}},r=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function i(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,s){return e&&i(t.prototype,e),s&&i(t,s),t}}(),o=function(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t},n={_splitPages:function(){var t=this._storage.get(a.STORAGE_NAME),e=this._globalHelpers.chunk(t.productsId,this._self.options.perPage);t.pagination.totalPages=e.length,t.pagination.perPage=this._self.options.perPage,this._storage.set(a.STORAGE_NAME,t)},_createLoadMore:function(){var t,e=$("<div />",{class:this._self.options.loadMoreWrapperClass}),s=$("<button />",(t={class:this._self.options.loadMoreBtnClass},o(t,"data-wishlist-page",2),o(t,"data-wishlist-load-more-btn","data-wishlist-load-more-btn"),t)).text(this._self.options.loadMoreText);e.append(s),e.insertAfter("[data-wishlist-items]")},_loadMoreActions:function(){var r=this;$(document).on("click","[data-wishlist-load-more-btn]",function(t){t.preventDefault();var e=r._storage.get(a.STORAGE_NAME),s=$(t.currentTarget),i=s.data("wishlistPage"),o=i+1;r._addLoadMoreClass(),i>=e.pagination.totalPages&&s.hide(),r._setUrlHash(i),r._renderProducts(i),s.data("wishlistPage",o)})},_setLoadMoreBtn:function(){var t=this._storage.get(a.STORAGE_NAME),e=$(document).find("[data-wishlist-load-more-btn]");t.pagination.page>=t.pagination.totalPages?e.hide():e.show()},_resetLoadMoreBtn:function(){$(document).find("[data-wishlist-load-more-btn]").data("wishlistPage",2)},_setUrlHash:function(t){var e=this._storage.get(a.STORAGE_NAME),s=void 0!==t?t:1;e.pagination.page=s,window.location.hash=s,this._storage.set(a.STORAGE_NAME,e)}},l={_setPadding:function(t){return this._self.options.zeroPadding?this._self.globalHelpers.pad(t):t},_addEmptyClass:function(){a.BODY.addClass(this._self.options.emptyClass)},_removeEmptyClass:function(){a.BODY.removeClass(this._self.options.emptyClass)},_addLoadMoreClass:function(){a.BODY.addClass(this._self.options.loadMoreBodyClass)},_removeLoadMoreClass:function(){a.BODY.removeClass(this._self.options.loadMoreBodyClass)},_addOrderByClass:function(){a.BODY.addClass(this._self.options.orderByBodyClass)},_removeOrderByClass:function(){a.BODY.removeClass(this._self.options.orderByBodyClass)}},d=new(function(){function e(){r(this,e)}return i(e,[{key:"_setInstance",value:function(t){this._self=t,this._vtexHelpers=t.vtexHelpers,this._globalHelpers=t.globalHelpers,this._vtexMasterdata=t.vtexMasterdata,this._vtexCatalog=t.vtexCatalog,this._storage=t.storage,this._session=t.storage.session,this._globalHelpers.extend(e.prototype,l,s,n)}},{key:"_initStorage",value:function(){var t={userEmail:null,userId:null,productsId:[],pagination:{page:1,perPage:this._self.options.perPage,totalPages:1}};this._globalHelpers.isNull(this._storage.get(a.STORAGE_NAME))&&this._storage.set(a.STORAGE_NAME,t),this._globalHelpers.isNull(this._session.get(a.SESSION_NAME))&&this._session.set(a.SESSION_NAME,{userDefined:!1})}},{key:"_setWishlistProduct",value:function(){var o=this;$(document).on("click","[data-wishlist-add]",this._globalHelpers.debounce(function(t){t.preventDefault();var e=$(t.currentTarget),s=e.data("wishlistProductId"),i=o._storage.get(a.STORAGE_NAME);return!o._session.get(a.SESSION_NAME).userDefined&&0<o._globalHelpers.length(i.productsId)?(o._setWishlistUser(),o._vtexHelpers.openPopupLogin(!o._self.options.reloadPage),!1):o._checkUserEmail()?(e.addClass(o._self.options.loaderClass),$("[data-wishlist-add]").prop("disabled",!0),o._removeWishlistProduct(s,e),void o._addWishlistProduct(s,e)):(o._vtexHelpers.openPopupLogin(!o._self.options.reloadPage),!1)},70))}},{key:"_addWishlistProduct",value:function(e,s){var i=this,t=this._storage.get(a.STORAGE_NAME);t.productsId.some(function(t){return t===e})||($(document).trigger(a.EVENTS.REQUEST_START),$(document).trigger(a.EVENTS.REQUEST_ADD_START),t.productsId.push(e),this._storage.set(a.STORAGE_NAME,t),this._vtexMasterdata.updateUser(t.userEmail,{wishlistProducts:JSON.stringify(t.productsId)}).done(function(t){s.addClass(i._self.options.activeClass),s.attr("title",i._self.options.linkTitle.remove),s.removeClass(i._self.options.loaderClass),$("[data-wishlist-add]").prop("disabled",!1),$(document).trigger(a.EVENTS.REQUEST_END,[e]),$(document).trigger(a.EVENTS.REQUEST_ADD_END,[e]),i._storageObserve()}).fail(function(t){return window.console.log(t)}))}},{key:"_removeWishlistProduct",value:function(s,e){var i=this,o=this._storage.get(a.STORAGE_NAME),t=o.productsId.some(function(t){return t===s}),r=o.productsId.filter(function(t){return t!==s});if(e.hasClass(this._self.options.activeClass))return $(document).trigger(a.EVENTS.REQUEST_START),$(document).trigger(a.EVENTS.REQUEST_REMOVE_START),t&&this._vtexMasterdata.updateUser(o.userEmail,{wishlistProducts:JSON.stringify(r)}).done(function(t){e.removeClass(i._self.options.activeClass),e.attr("title",i._self.options.linkTitle.add),o.productsId=r,i._storage.set(a.STORAGE_NAME,o),e.removeClass(i._self.options.loaderClass),$("[data-wishlist-add]").prop("disabled",!1),$(document).find("[data-wishlist-add]").map(function(t,e){s===$(e).data("wishlistProductId")&&$(e).removeClass(i._self.options.activeClass)}),$(document).trigger(a.EVENTS.REQUEST_END,[s]),$(document).trigger(a.EVENTS.REQUEST_REMOVE_END,[s]),i._storageObserve()}).fail(function(t){return window.console.log(t)}),!1}},{key:"_clearWishlist",value:function(){var i=this;$(document).on("click","[data-wishlist-clear]",function(t){t.preventDefault();var e=$(document).find("[data-wishlist-add]"),s=i._storage.get(a.STORAGE_NAME);if(s.productsId.length<1)return!1;$(document).trigger(a.EVENTS.BEFORE_CLEAR_ITEMS),s.productsId=[],i._storage.set(a.STORAGE_NAME,s),i._vtexMasterdata.updateUser(s.userEmail,{wishlistProducts:"[]"}).done(function(t){e.map(function(t,e){return $(e).removeClass(i._self.options.activeClass)}),i._update()}).fail(function(t){return window.console.log(t)}).always(function(){return $(document).trigger(a.EVENTS.AFTER_CLEAR_ITEMS)})})}},{key:"_storageObserve",value:function(){var i=this,t=this._storage.get(a.STORAGE_NAME);if(this._setUserData(),this._setLoadMoreBtn(),this._splitPages(),this._globalHelpers.isNull(t))$("[data-wishlist-amount]").html(this._setPadding(0));else{var e=$(document).find("[data-wishlist-add]");$("[data-wishlist-amount]").html(this._setPadding(t.productsId.length)),t.productsId.map(function(s){e.map(function(t,e){s===$(e).data("wishlistProductId")&&($(e).addClass(i._self.options.activeClass),$(e).attr("title",i._self.options.linkTitle.remove))})})}}},{key:"_update",value:function(){this._setUrlHash(),this._splitPages(),this._resetLoadMoreBtn(),this._storageObserve(),this._renderProducts()}},{key:"_checkUserEmail",value:function(){return null!==this._storage.get(a.STORAGE_NAME).userEmail}},{key:"_setUserData",value:function(){var e=this,s=this._storage.get(a.STORAGE_NAME),i=this._session.get(a.SESSION_NAME);if(i.userDefined&&0<this._globalHelpers.length(s.productsId))return!1;this._vtexHelpers.checkLogin().done(function(t){s.userEmail=t.Email,s.userId=t.UserId,e._storage.set(a.STORAGE_NAME,s),i.userDefined||e._setWishlistUser()})}},{key:"_setWishlistUser",value:function(){var i=this;this._checkWishlistUser().done(function(t){if(t.hasUser){var e=i._storage.get(a.STORAGE_NAME),s=i._session.get(a.SESSION_NAME);e.productsId=JSON.parse(t.userData.wishlistProducts||"[]"),s.userDefined=!0,i._storage.set(a.STORAGE_NAME,e),i._session.set(a.SESSION_NAME,s),setTimeout(function(){return i._storageObserve()},a.DELAY_TIME)}}).fail(function(t){return window.console.log(t)})}},{key:"_checkWishlistUser",value:function(){var s=this,t=this._storage.get(a.STORAGE_NAME),i=this._session.get(a.SESSION_NAME),o={hasUser:!1,userData:null};return $.Deferred(function(e){return!i.userDefined&&s._vtexMasterdata.getUser(t.userEmail,a.RETRIEVED_DATA).done(function(t){0<s._globalHelpers.length(t.result.dataResponse)&&(o.hasUser=!0,o.userData=t.result.dataResponse),e.resolve(o)}).fail(function(t){return e.reject(t)})}).promise()}}]),e}()),u={setOptions:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this.options=this.globalHelpers.extend({},e,this.globalHelpers.isPlainObject(t)&&t),!this.options.storeName||!this.globalHelpers.isString(this.options.storeName))throw new Error(a.MESSAGES.storeName);if(!this.options.shelfId||!this.globalHelpers.isString(this.options.shelfId))throw new Error(a.MESSAGES.shelfId);if(null===this.options.notFound)this.options.notFound=function(){return'<div class="wishlist__not-found">Nenhum produto em sua lista</div>'};else{if(!this.globalHelpers.isFunction(this.options.notFound))throw new Error(a.MESSAGES.notFound);this.options.notFound.call(this)}this.vtexMasterdata.setStore(this.options.storeName),d._setInstance(this),this._initWishlist()},_initWishlist:function(){var s=this;d._initStorage(),d._storageObserve(),d._setWishlistProduct(),d._changeOrder(),d._clearWishlist(),d._setUrlHash(),d._splitPages(),d._createLoadMore(),d._setLoadMoreBtn(),d._loadMoreActions(),d._renderProducts(),$(window).on("authenticatedUser.vtexid",function(t){return setTimeout(function(){return s.update()},a.DELAY_TIME)}),$(window).on("closed.vtexid",function(t){return setTimeout(function(){return s.update()},a.DELAY_TIME)}),$(document).on("requestAddEnd.vtexWishlist",function(t,e){return s.update()}),$(document).on("requestRemoveEnd.vtexWishlist",function(t,e){return s.update()})},update:function(){d._update()},renderProducts:function(){d._renderProducts()}};return function t(e,s,i){var o=3<arguments.length&&void 0!==arguments[3]&&arguments[3];if(r(this,t),this.version="0.3.0",this.name="@VtexWishlist",void 0===e)throw new TypeError(a.MESSAGES.vtexUtils);if("@VtexUtils"!==e.name)throw new TypeError(a.MESSAGES.vtexUtils);if(e.version<a.MESSAGES.vtexUtilsVersion)throw new Error(a.MESSAGES.vtexUtilsVersionMessage);if(this.globalHelpers=e.globalHelpers,this.vtexHelpers=e.vtexHelpers,void 0===s)throw new Error(a.MESSAGES.vtexMasterdata);this.vtexMasterdata=s,this.vtexCatalog=new i(e,o),this.storage=e.storage,this.globalHelpers.extend(t.prototype,u)}});